# Сервер взаимодействия 1C с PostgreSQL и MinIO

## Навигация

- [Описание](#описание)
- [Структура проекта](#структура-проекта)
- [Используемые технологии](#используемые-технологии)
- [Требования](#требования)
- [Конфигурация](#конфигурация)
- [Установка и запуск](#установка-и-запуск)
- [Управление контейнерами](#управление-контейнерами)
- [Просмотр логов](#просмотр-логов)

## Описание

Этот проект предоставляет конфигурацию для развертывания сервера взаимодействия 1C с базой данных PostgreSQL и объектным хранилищем MinIO в Docker Compose. Он предназначен для интеграции 1C с современными системами хранения данных и упрощения управления сервисами. Взаимодействие с MinIO осуществляется через 1C Предприятие, поэтому порт 9000 (API MinIO) открыт для внешнего доступа.

## Структура проекта

Проект включает три основных сервиса, развернутых в Docker:

1. **collab_server** — сервер взаимодействия 1C.
2. **postgres_db** — база данных PostgreSQL.
3. **minio** — объектное хранилище MinIO.

## Используемые технологии

- **Сервер взаимодействия 1C**: Версия 26.0.53, развернут на Debian Bookworm.
- **PostgreSQL**: Версия 17.3.
- **MinIO**: Версия RELEASE.2025-02-28T09-55-16Z.

## Требования

Для работы проекта необходимы:
- **Docker**: Рекомендуемая версия 28.0.1 или выше. Проверьте версию командой:
  ```bash
  docker --version
  ```
- **Docker Compose**: Рекомендуемая версия v2.33.1 или выше (плагин). Проверьте версию командой:
  ```bash
  docker compose version
  ```
  Примечание: Если используется старая версия Docker Compose (1.x), команда будет `docker-compose --version`.
- **Архив**: `1c_cs_26.0.53_linux_x86_64.tar.gz`.
- **Установочный пакет AxiomJDK**: `axiomjdk-jre-pro11.0.25+11-linux-amd64.deb`.

## Конфигурация

- **Сеть**:
  - `internal_net`: Внутренняя сеть для взаимодействия сервисов.
  - `external_net`: Внешняя сеть для доступа к `collab_server`.

- **Порты**:
  - `collab_server`: Маппинг порта `9090:9090` (хост:контейнер).
  - `postgres_db`: Порт `5432` доступен внутри сети `internal_net`.
  - `minio`: Порты `9000:9000` (API, маппинг на хост для взаимодействия через 1C Предприятие) и `9001` (консоль, доступна внутри сети `internal_net`).

- **Временная зона**:
  - Во всех контейнерах (`collab_server`, `postgres_db`, `minio`) установлена временная зона `Europe/Moscow`.

- **Переменные окружения**:
  Настройте файл `.env` на основе `.env.example`. Основные параметры:

  - **PostgreSQL**:
    - `POSTGRES_URL`: URL подключения к PostgreSQL (по умолчанию: `postgresql://postgres_image:5432`).
    - `POSTGRES_USER`: Имя пользователя (по умолчанию: `admpostgres`).
    - `POSTGRES_PWD`: Пароль (по умолчанию: `admpostgres`).
    - `POSTGRES_DB`: Имя базы данных (по умолчанию: `csdbdev`).

  - **MinIO**:
    - `MINIO_SERVER`: Адрес сервера MinIO (пример: `http://192.168.1.10:9000`). Укажите IP-адрес хоста, на котором разворачивается Docker Compose, так как взаимодействие с MinIO идет через 1C Предприятие, а не напрямую внутри контейнеров.
    - `MINIO_ROOT_USER`: Администратор MinIO (по умолчанию: `minioadmin`).
    - `MINIO_ROOT_PASSWORD`: Пароль администратора (по умолчанию: `minioadmin`).
    - `MINIO_BUCKET_NAME`: Имя бакета (по умолчанию: `cs-bucket`).
    - `MINIO_ACCESS_KEY_ID`: Ключ доступа (по умолчанию: `f62e18ecb9476e2409a0`).
    - `MINIO_SECRET_KEY`: Секретный ключ (по умолчанию: `2e263adef0a35fd37a97c45142bfa1549dd1615f`).

  **Генерация ключей для MinIO**:
  Вы можете сгенерировать собственные `MINIO_ACCESS_KEY_ID` и `MINIO_SECRET_KEY` с помощью OpenSSL:
  ```bash
  openssl rand -hex 10  # Для MINIO_ACCESS_KEY_ID (20 символов)
  openssl rand -hex 16  # Для MINIO_SECRET_KEY (32 символа)
  ```
  Замените значения в `.env` на сгенерированные.

## Установка и запуск

1. **Клонирование репозитория**:

    ```bash
    git clone <URL_репозитория>
    cd <папка_проекта>
    ```

2. **Копирование необходимых файлов**:

    ```bash
    cp 1c_cs_26.0.53_linux_x86_64.tar.gz ./collab_serv/
    cp axiomjdk-jre-pro11.0.25+11-linux-amd64.deb ./collab_serv/
    ```

3. **Настройка файла окружения**:

    ```bash
    cp .env.example .env
    ```

    Откройте файл `.env` и укажите свои учетные данные. Обязательно укажите в `MINIO_SERVER` IP-адрес хоста с портом `9000` (например, `http://192.168.1.10:9000`). При необходимости сгенерируйте новые ключи для MinIO.

4. **Сборка и запуск контейнеров**:

    ```bash
    make up_build
    ```

    Команда соберет Docker-образы и запустит все сервисы в фоновом режиме.

5. **Подключение к контейнерам**:

    - К серверу взаимодействия 1C:
      ```bash
      make conn_cs
      ```
    - К PostgreSQL:
      ```bash
      make conn_psql
      ```
    - К MinIO:
      ```bash
      make conn_mi
      ```

## Управление контейнерами

1. **Остановка контейнеров**:

    ```bash
    make stop
    ```

2. **Перезапуск контейнеров**:

    ```bash
    make restart
    ```

3. **Очистка ресурсов**:

    ```bash
    make prune
    ```

## Просмотр логов

- Логи всех контейнеров:
  ```bash
  make logs_all
  ```

- Логи сервера взаимодействия 1C:
  ```bash
  make logs_cs
  ```

- Логи PostgreSQL:
  ```bash
  make logs_pg
  ```

- Логи MinIO:
  ```bash
  make logs_mi
  ```
